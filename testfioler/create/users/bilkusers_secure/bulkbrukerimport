# importererbrukere fra CSV-fil og legger dem til i Active Directory
# csv-filen skal ha kolonnene: eployeeid, FirstName, LastName
function Get-eployeeFromCsv {
    [cmdletBinding()]
    param (
        [Parameter(Mandatory)]
        [string]$filePath,
        [Parameter(Mandatory)]
        [string]$Delimiter,
        [Parameter(Mandatory)]
        [hashtable]$SyncfieldMap
    )
    
    try {
        $SyncProperties=$SyncfieldMap.GetEnumerator()
        $properties=foreach($property in $SyncProperties){
            @{Name=$property.Value;Expression=[scriptblock]::Create("`$_.$($property.Key)")}
        }

        Import-Csv -Path $filePath -Delimiter $Delimiter | Select-Object -Property $properties
    }
    catch {
        <#Do this if a terminating exception happens#>
        write-error "An error occurred: $_.Exception.Message"
    }

}
$SyncfieldMap = @{
    EmployeeID="EmployeeID"
    FirstName="GivenName"
    LastName="Surname"
    phone="telephoneNumber"
    ou="ou"
    password="password"
}

# dockumenting the password and whom it was created for in a csv file. starting with header
$filePathcsv = "C:\Users\Administrator\Documents\csv\brukere.csv"
$header = "givenName,surname,username,password"
$filedata = @()
$filedata += "$header `n"

# ensure target file and parent folder exist
$dir = Split-Path -Path $filpath -Parent
if (-not (Test-Path $dir)) { New-Item -Path $dir -ItemType Directory -Force | Out-Null }
if (-not (Test-Path $filpath)) { New-Item -Path $filpath -ItemType File -Force | Out-Null }

try {
    # remove inherited ACLs
    icacls $filpath /inheritance:r | Out-Null

    # grant full control to the local Administrator account and to SYSTEM only
    icacls $filpath /grant:r "Administrator:(F)" "SYSTEM:(F)" | Out-Null

    # remove common built-in groups so only Administrator and SYSTEM keep access
    icacls $filpath /remove "Users" "Authenticated Users" "Everyone" | Out-Null
}
catch {
    Write-Warning "Failed to set file ACL on $filpath : $_"
}


# Get-eployeeFromCsv -filePath ".\testfioler\create\users.csv" -Delimiter "," -SyncfieldMap $SyncfieldMap
$userinfo = Get-eployeeFromCsv -filePath "C:\Users\Administrator\Documents\csv\brukere.csv" -Delimiter "," -SyncfieldMap $SyncfieldMap
foreach ($user in $userinfo) {
    # gets variables ready for user creation
    # checks if the ou field is empty or null and sets it to brukere if it is
    if ([string]::IsNullOrEmpty($user.ou)) {
        <# Action to perform if the condition is true #>
        $user.ou = "brukere"
    }
    # sets the ou path based on the ou field in the csv
    $OU = "ou=$($user.ou),OU=users,OU=drageideou,DC=drageide,DC=com"
    $Domain = "drageide.com"
    $Email = "$($user.Givenname).$($user.Surname)@$Domain"
    # first generates a random password then checks if the password field in the csv is empty or null and uses that password instead if it is not
    $randpassword = [System.Web.Security.Membership]::GeneratePassword(12,2)
    $randomnumbers = -join ((48..57) | Get-Random -Count 2 | ForEach-Object {[char]$_})
    $specials = (33..47) + (58..64) + (91..96) + (123..126)
    $randomSpecials = -join ($specials | Get-Random -Count 2 | ForEach-Object {[char]$_})
    $randpassword += $randomnumbers + $randomSpecials
    if (-not [string]::IsNullOrEmpty($user.password)) {
        $randpassword = $user.password
    }

    New-ADUser `
        -EmployeeID $user.EmployeeID `
        -UserPrincipalName "$($user.GivenName).$($user.Surname)@$Domain" `
        -GivenName $user.GivenName `
        -Surname $user.Surname `
        -Name "$($user.GivenName) $($user.Surname)" `
        -SamAccountName "$($user.GivenName.Substring(0,2))$($user.Surname.Substring(0,3))" `
        -Path $OU `
        -EmailAddress $Email `
        -AccountPassword (ConvertTo-SecureString "$randpassword" -AsPlainText -Force) `
        -Enabled $true `
        -PasswordNeverExpires $false `
        -ChangePasswordAtLogon $false

    # writes the users name lastname and the generated password to a csv file
    $output = [PSCustomObject]@{
        GivenName = $user.GivenName
        Surname = $user.Surname
        username = "$($user.GivenName.Substring(0,2))$($user.Surname.Substring(0,3))"
        Password = $randpassword
    }
    $filedata += "$($output.GivenName),$($output.Surname),$($output.username),$($output.Password) `n"
}
# writes the collected data to the csv file
$filedata | Out-File -FilePath $filePathcsv -Encoding UTF8